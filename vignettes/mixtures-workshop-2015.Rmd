---
title: "NIEHS Mixtures workshop 2015"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{NIEHS Mixtures Workshop 2015}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd(here::here("vignettes"))

library(magrittr)
```

See https://www.niehs.nih.gov/news/events/pastmtg/2015/statistical/index.cfm

## Simulated Dataset 1

### Import data

```{r data1_import}
data = rio::import("../inst/extdata/niehs-2015-dataset1.xls")
str(data)

task = list(
  id = "obs",
  exposures = paste0("X", 1:7),
  outcome = "Y")

task$covariates = setdiff(names(data), c(task$id, task$exposures, task$outcome))
task
```

### Exploratory data analysis

TODO: determine if we need to log-transform the data.

```{r data1_eda}
library(ggplot2)

for (exposure in task$exposures) {
  print(qplot(data[[exposure]]) + ggtitle(paste("Exposure:", exposure)) + theme_minimal())
}


# Log-transform the data.
for (exposure in task$exposures) {
  data[[exposure]] = log(data[[exposure]])
}

summary(data)

for (exposure in task$exposures) {
  print(qplot(data[[exposure]]) + ggtitle(paste("Exposure:", exposure)) + theme_minimal())
}

# Also log-transform Y?
# No, doesn't seem log-normally distributed.
qplot(data[[task$outcome]])
qplot(log(data[[task$outcome]]))



```

### Estimation

```{r data1_model}

library(tlmixture)
#folds_cvtmle = 2L
folds_cvtmle = 5L
estimators = c("SL.mean", "SL.glmnet", "SL.ranger")
cluster_exposures = FALSE
verbose = TRUE
quantiles_exposures = 4L
quantiles_mixtures = 3L

names(data)
class(data)

#(exposures = paste0("X", 1:3))

df = data[, !names(data) %in% task$id]
str(df)

# Normalize the exposures.
for (exposure in task$exposures) {
  df[[exposure]] = (df[[exposure]] - mean(df[[exposure]])) / sd(df[[exposure]])
}

# Review exposure distributions.
summary(df[, task$exposures])


# Compare to OLS.
reg = lm(as.formula(paste(task$outcome, "~ .")), data = df)
summary(reg)

# Create a noise z2 - temporary.
# TODO: fix tlmixture to work with 1 or 0 adjustment variables.
df$z2 = rnorm(nrow(df))

result = tlmixture(df, outcome = task$outcome,
                   exposures = task$exposures,
                   quantiles_exposures = quantiles_exposures,
                   #quantiles_mixtures = quantiles_mixtures,
                   quantiles_mixtures = 4,
                   #quantiles_mixtures = 5,
                   estimator_outcome = estimators,
                   cluster_exposures = cluster_exposures,
                   mixture_fn = tlmixture::mixture_glm,
                   #folds_cvtmle = folds_cvtmle,
                   #folds_cvtmle = 3,
                   folds_cvtmle = 5,
                   #folds_cvtmle = 10,
                   #folds_cvtmle = 20,
                   verbose = TRUE)
```

### Review results

```{r data1_results}
summary(result$outcome_rescaled)
data[[result$outcome]] = result$outcome_rescaled

# Analyze mixture distribution.
mix_result = analyze_mixture(data, result,
                             name = "Dataset 1",
                             reg_vars = task$covariates,
                             vars_desc = task$covariates)

# TODO: consider integrating plot_analysis() into analyze_mixture()
plot_analysis(mix_result)

weight_df = do.call(rbind, sapply(result$folds, `[[`, "weights"))
colMeans(weight_df)
```

```{r data1_display, results="asis"}
display_mixture(mix_result)
# Run again, this time as latex.
options(knitr.table.format = "latex")
kab_tab = display_mixture(mix_result)
cat(kab_tab, file = "data1-summary-table.tex")
# Restore previous table format setting.
# We unfortunately can't just assign it to NULL :/ Have to pick a specific value.
options(knitr.table.format = "html")
      
```

## Simulated Dataset 2

### Import data

```{r data2_import}
data = rio::import("../inst/extdata/niehs-2015-dataset2.xls")
str(data)

names(data) = tolower(names(data))

task = list(
  id = "obs",
  exposures = paste0("x", 1:14),
  outcome = "y")

task$covariates = setdiff(names(data), c(task$id, task$exposures, task$outcome))
task
```

### Exploratory data analysis

TODO: determine if we need to log-transform the data.

```{r data2_eda}
library(ggplot2)

for (exposure in task$exposures) {
  print(qplot(data[[exposure]]) + ggtitle(paste("Exposure:", exposure)) + theme_minimal())
}


# Skip log-transforming the data.
if (FALSE) {
for (exposure in task$exposures) {
  data[[exposure]] = log(data[[exposure]])
}

print(summary(data))

for (exposure in task$exposures) {
  print(qplot(data[[exposure]]) + ggtitle(paste("Exposure:", exposure)) + theme_minimal())
}

}

```

### Estimation

```{r data2_model}

library(tlmixture)
#folds_cvtmle = 2L
folds_cvtmle = 5L
estimators = c("SL.mean", "SL.glmnet", "SL.ranger")
cluster_exposures = FALSE
verbose = TRUE
quantiles_exposures = 4L
quantiles_mixtures = 3L

names(data)
(exposures = task$exposures)
class(data)

task$exposures

# Simpler version.
#(exposures = paste0("x", 1:3))

df = data[, !names(data) %in% task$id]
str(df)

# Create a noise z2 - temporary.
# TODO: fix tlmixture to work with 1 or 0 adjustment variables.
#df$z2 = rnorm(nrow(df))

result = tlmixture(df, outcome = task$outcome,
                   exposures = exposures,
                   quantiles_exposures = quantiles_exposures,
                   #quantiles_mixtures = quantiles_mixtures,
                   quantiles_mixtures = 4,
                   #quantiles_mixtures = 5,
                   estimator_outcome = estimators,
                   cluster_exposures = cluster_exposures,
                   #folds_cvtmle = folds_cvtmle,
                   #folds_cvtmle = 3,
                   folds_cvtmle = 5,
                   #folds_cvtmle = 10,
                   #folds_cvtmle = 20,
                   verbose = TRUE)
```

### Review results

```{r data2_results}
summary(result$outcome_rescaled)
data[[result$outcome]] = result$outcome_rescaled
# Analyze mixture distribution.
# TODO: fix "unknown column" error due to rescaling of outcome variable.
mix_result = analyze_mixture(data, result,
                             name = "Dataset 2",
                             reg_vars = task$covariates,
                             vars_desc = task$covariates)

# TODO: get plot_analysis() working.
plot_analysis(mix_result)
```
```{r results="asis"}
# Run once and display as html.
display_mixture(mix_result)
# Run again, this time as latex.
options(knitr.table.format = "latex")
kab_tab = display_mixture(mix_result)
cat(kab_tab, file = "data2-summary-table.tex")
# Restore previous table format setting.
options(knitr.table.format = "html")
#getOption("knitr.table.format")
```
